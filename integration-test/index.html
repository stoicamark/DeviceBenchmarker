<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
                
    <title>Adaptive Cache Test</title>
    <h1>Adaptive cache test</h1>

    <body>
        <input type="file" id="files" name="file" /> 
        <button id="readFile">Read selected file</button>
        <div id="text_content"></div>

        <div id="integration-test"></div>
    </body>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
            integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc="
            crossorigin="anonymous">
    </script>
    
    <script>
        function readBlob() {
    
        var files = document.getElementById('files').files;
        if (!files.length) {
            alert('Please select a file!');
            return;
        }
    
        var file = files[0];
    
        var reader = new FileReader();
    
        // If we use onloadend, we need to check the readyState.
        reader.onloadend = function(evt) {
            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                let textContent = evt.target.result;
                console.log(textContent)
                plotTest(textContent)
            }
        };
        var blob = file.slice(0, file.size - 1);
        reader.readAsText(blob);
        }
        document.getElementById('readFile').addEventListener('click', readBlob, false);
    
        function plotTest(textContent){
            let obj = JSON.parse(textContent)

            var peerKey = function(peerRecord){
                return peerRecord.id;
            }

            let dict = {};

            obj.forEach(record => {
                if(dict[peerKey(record)] === undefined){
                    dict[peerKey(record)] = []
                }
                dict[peerKey(record)].push(record)
            })

            let traces = [];

            for(var key in dict){
                let peer = dict[key]
                let x = []
                let y = []

                peer.forEach(record => {
                    y.push(record.batteryLevel)
                    x.push(record.timeStamp)
                })

                let trace = {
                    x: x,
                    y: y,
                    name: peer[0].id,
                    type: 'scatter'
                }
                traces.push(trace)
            }
            console.log(traces)
            
            let layout = {
                xaxis: {
                    title: 'time',
                    type: 'number',
                },
                yaxis: {
                    title: 'battery level',
                    type: 'number',
                },

                title: "Adaptive cache test with benchmarker"
            }

            TESTER = document.getElementById('integration-test')
            Plotly.plot(TESTER, traces, layout)
        }
    </script>
</html>